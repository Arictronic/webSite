// –¢—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç —Å 30 –ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º –≤ –≤–µ–± —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ –∞—Ä—Ö–µ—Ç–µ–∫—Ç—É—Ä–µ.
// –¢–µ–±–µ –ø—Ä–µ–¥–∞—Å—Ç–∞–≤–ª–µ–Ω –∫–æ–¥ –ø–æ —Ä–∞–±–æ—Ç–µ –ª–æ–≥–æ—Ç–∏–ø–∞, —Å–æ –≤–∫–ª–∞–¥–∫–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (tabLogo) –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —á—Ç–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç.
// –¢–∞–∫–∂–µ Html –∫—É—Å–æ–∫ –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –ø–∞–Ω–µ–ª—å —ç–∫—Å–ø–æ—Ä—Ç–∞:
// <!-- Logo -->
// <div
//   class="tab-panel"
//   id="panelLogo"
//   role="tabpanel"
//   aria-labelledby="tabLogo"
//   hidden
// >
//   <div class="grid2">
//     <div class="field">
//       <label>
//         <input id="logoEnabled" type="checkbox" />
//         –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–æ—Ç–∏–ø –Ω–∞ —Ñ–æ–Ω–µ
//       </label>
//     </div>

//     <div class="field">
//       <label for="logoOpacity">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (0‚Äì100%)</label>
//       <div class="range-wrap">
//         <input
//           id="logoOpacity"
//           type="range"
//           min="0"
//           max="100"
//           step="1"
//           value="12"
//         />
//         <span id="logoOpacityVal">12%</span>
//       </div>
//     </div>
//   </div>

//   <div class="field">
//     <label for="logoLayout">–†–µ–∂–∏–º –≤–æ—Ç–µ—Ä–º–∞—Ä–∫–∏</label>
//     <select id="logoLayout">
//       <option value="center">–¶–µ–Ω—Ç—Ä</option>
//       <option value="tile" selected>–ü–ª–∏—Ç–∫–∞</option>
//       <option value="diagonal">–î–∏–∞–≥–æ–Ω–∞–ª—å–Ω–∞—è –ø–ª–∏—Ç–∫–∞</option>
//     </select>
//     <div class="note">
//       –î–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∂–∏–º—ã –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç –ª–æ–≥–æ—Ç–∏–ø –Ω–∞ 45¬∞
//     </div>
//   </div>

//   <div class="grid2">
//     <div class="field">
//       <label for="logoVariant">–í–∞—Ä–∏–∞–Ω—Ç –ª–æ–≥–æ—Ç–∏–ø–∞</label>
//       <select id="logoVariant">
//         <option value="1">–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π SVG</option>
//         <option value="2">–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π PNG</option>
//         <option value="3">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª</option>
//       </select>
//     </div>

//     <div class="field">
//       <label>
//         <input id="logoRecolor" type="checkbox" />
//         –ü–µ—Ä–µ–∫—Ä–∞—Å–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø
//       </label>

//       <div id="logoColorWrap" style="display: none; margin-top: 8px">
//         <div class="field">
//           <label for="logoColor">–¶–≤–µ—Ç –ø–µ—Ä–µ–∫—Ä–∞—Å–∫–∏</label>
//           <div class="color-input">
//             <input
//               id="logoColor"
//               type="color"
//               value="#0ea5e9"
//               aria-label="–¶–≤–µ—Ç –ª–æ–≥–æ—Ç–∏–ø–∞"
//             />
//             <span
//               class="color-preview"
//               id="colorPreview"
//               style="background-color: #0ea5e9"
//             ></span>
//           </div>
//         </div>
//       </div>
//     </div>
//   </div>

//   <!-- –ë–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ 3) -->
//   <div
//     id="logoUploadWrap"
//     style="
//       display: none;
//       margin-top: 15px;
//       padding: 15px;
//       background: #f8fafc;
//       border-radius: 8px;
//     "
//   >
//     <div class="field">
//       <label for="logoUpload">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —Ñ–∞–π–ª:</label>
//       <div class="file-upload">
//         <input
//           type="file"
//           id="logoUpload"
//           accept="image/svg+xml,image/png,image/jpeg,image/gif,image/webp"
//         />
//         <div id="logoPreview" class="file-preview"></div>
//       </div>
//       <div class="note" style="font-size: 11px; margin-top: 5px">
//         –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: SVG, PNG, JPG, GIF, WebP. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è SVG
//         –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞.
//       </div>
//     </div>

//     <div class="actionsRow" style="margin-top: 10px">
//       <button id="logoClearUpload" type="button" class="ghost small">
//         –£–¥–∞–ª–∏—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
//       </button>
//     </div>
//   </div>

//   <div class="hr"></div>

//   <div class="grid2">

//     <div class="field">
//       <label for="logoTileSize">–†–∞–∑–º–µ—Ä –ª–æ–≥–æ—Ç–∏–ø–∞ (%)</label>
//         <div class="range-wrap">
//           <input
//             id="logoTileSize"
//             type="range"
//             min="0"
//             max="1000"
//             value="30"
//           />
//           <input
//             id="logoTileSizeNum"
//             type="number"
//             value="30"
//             min="0"
//             max="1000"
//             style="margin-left: 10px; width: 80px"
//           />
//         </div>
    
//     </div>

//     <div class="field">
//       <label for="logoRotation">–ü–æ–≤–æ—Ä–æ—Ç (–≥—Ä–∞–¥—É—Å—ã)</label>
//       <div class="range-wrap">
//         <input
//           id="logoRotation"
//           type="range"
//           min="-180"
//           max="180"
//           value="30"
//         />
//         <input
//           id="logoRotationNum"
//           type="number"
//           value="30"
//           min="-180"
//           max="180"
//           style="margin-left: 10px; width: 80px"
//         />
//       </div>
//     </div>
//   </div>

//   <div class="grid2">
//     <div class="field">
//       <label for="logoHorizontalGap"
//         >–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø (px)</label
//       >
//       <div class="range-wrap">
//         <input
//           id="logoHorizontalGap"
//           type="range"
//           min="0"
//           max="800"
//           value="180"
//         />
//         <input
//           id="logoHorizontalGapNum"
//           type="number"
//           value="180"
//           min="0"
//           max="800"
//           style="margin-left: 10px; width: 80px"
//         />
//       </div>
//     </div>

//     <div class="field">
//       <label for="logoVerticalGap">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø (px)</label>
//       <div class="range-wrap">
//         <input
//           id="logoVerticalGap"
//           type="range"
//           min="0"
//           max="800"
//           value="180"
//         />
//         <input
//           id="logoVerticalGapNum"
//           type="number"
//           value="180"
//           min="0"
//           max="800"
//           style="margin-left: 10px; width: 80px"
//         />
//       </div>
//     </div>
//   </div>

//   <div class="grid2">
//     <div class="field">
//       <label for="logoTileOffsetX">–°–º–µ—â–µ–Ω–∏–µ X (px)</label>
//       <div class="range-wrap">
//         <input
//           id="logoTileOffsetX"
//           type="range"
//           min="-2000"
//           max="2000"
//           value="0"
//         />
//         <input
//           id="logoTileOffsetXNum"
//           type="number"
//           value="0"
//           min="-2000"
//           max="2000"
//           style="margin-left: 10px; width: 80px"
//         />
//       </div>
//     </div>

//     <div class="field">
//       <label for="logoTileOffsetY">–°–º–µ—â–µ–Ω–∏–µ Y (px)</label>
//       <div class="range-wrap">
//         <input
//           id="logoTileOffsetY"
//           type="range"
//           min="-2000"
//           max="2000"
//           value="0"
//         />
//         <input
//           id="logoTileOffsetYNum"
//           type="number"
//           value="0"
//           min="-2000"
//           max="2000"
//           style="margin-left: 10px; width: 80px"
//         />
//       </div>
//     </div>
//   </div>
// </div>
// –°–∫–∞–∂–∏ –º–æ–∂–Ω–æ –ª–∏ —ç—Ç–æ—Ç –∫–æ–¥ –æ–ø—Ç–∏–º–∏–∑–æ–≤–∞—Ç—å, —Å–Ω–∞—á–∞–ª–æ –Ω–∞–ø–∏—à–∏ —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å. –ö–∞–∫ —è –ø–æ–ø—Ä–æ—à—É –∫–æ–¥, —Ç—ã –¥–æ–ª–∂–µ–Ω –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ –¥–ª—è —á–µ–≥–æ, –µ–≤–µ–Ω—Ç—ã –∏ —Ç.–¥., –¥–∞ –∏ –±–µ–∫–∞–ø —Ç–æ–∂–µ –æ—Ç–¥–µ–ª—å–Ω–æ

// tabLogo - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏
// logoVariant - –≤—ã–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ª–æ–≥–æ—Ç–∏–ø–∞ (1, 2, 3)
// logoUpload - –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–∞
// logoLayout - –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (center, tile, diagonal)
// logoEnabled - –≤–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–æ—Ç–∏–ø–∞
// logoOpacity - —Å–ª–∞–π–¥–µ—Ä –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
// logoOpacityNum - —á–∏—Å–ª–æ–≤–æ–µ –ø–æ–ª–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
// logoRecolor - —á–µ–∫–±–æ–∫—Å –ø–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞–Ω–∏—è
// logoColor - –≤—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞–Ω–∏—è
// logoTileSize - —Å–ª–∞–π–¥–µ—Ä —Ä–∞–∑–º–µ—Ä–∞ –ø–ª–∏—Ç–∫–∏
// logoTileSizeNum - —á–∏—Å–ª–æ–≤–æ–µ –ø–æ–ª–µ —Ä–∞–∑–º–µ—Ä–∞ –ø–ª–∏—Ç–∫–∏
// logoHorizontalGap - —Å–ª–∞–π–¥–µ—Ä –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –∑–∞–∑–æ—Ä–∞
// logoHorizontalGapNum - —á–∏—Å–ª–æ–≤–æ–µ –ø–æ–ª–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –∑–∞–∑–æ—Ä–∞
// logoVerticalGap - —Å–ª–∞–π–¥–µ—Ä –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–∑–æ—Ä–∞
// logoVerticalGapNum - —á–∏—Å–ª–æ–≤–æ–µ –ø–æ–ª–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–∑–æ—Ä–∞
// logoRotation - —Å–ª–∞–π–¥–µ—Ä –ø–æ–≤–æ—Ä–æ—Ç–∞
// logoRotationNum - —á–∏—Å–ª–æ–≤–æ–µ –ø–æ–ª–µ –ø–æ–≤–æ—Ä–æ—Ç–∞
// logoTileOffsetX - —Å–ª–∞–π–¥–µ—Ä —Å–º–µ—â–µ–Ω–∏—è X
// logoTileOffsetXNum - —á–∏—Å–ª–æ–≤–æ–µ –ø–æ–ª–µ —Å–º–µ—â–µ–Ω–∏—è X
// logoTileOffsetY - —Å–ª–∞–π–¥–µ—Ä —Å–º–µ—â–µ–Ω–∏—è Y
// logoTileOffsetYNum - —á–∏—Å–ª–æ–≤–æ–µ –ø–æ–ª–µ —Å–º–µ—â–µ–Ω–∏—è Y

function applyLogo() {
  const lg = state.settings.logo || {};
  if (!lg.enabled) {
    const layer = ensureLogoLayer();
    if (layer) layer.style.display = "none";
    return;
  }

  const layer = ensureLogoLayer();
  if (!layer) return;

  const logoMark = $("logoMark");
  if (!logoMark) return;

  const variant = getLogoVariant();
  const layout = lg.layout || "center";
  const opacityValue = (lg.opacity || 12) / 100;
  const rotation = lg.rotation || 0;
  const recolor = !!lg.recolor;
  const color = lg.color || "#0ea5e9";

  // –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
  const metrics = getScheduleMetrics();

  // –û—á–∏—â–∞–µ–º —Å—Ç–∏–ª–∏
  logoMark.style.cssText = "";
  layer.style.cssText = "";

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–æ–π
  layer.style.cssText = `
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
    overflow: hidden;
    display: block;
  `;

  // –ü–æ–ª—É—á–∞–µ–º URL –ª–æ–≥–æ—Ç–∏–ø–∞
  const src = getLogoDataUrl(variant, recolor ? color : null);

  if (layout === "center") {
    // –†–ê–°–ß–ï–¢ –†–ê–ó–ú–ï–†–ê –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    const tileSizePercent = clamp(Number(lg.tileSize || 30), 0, 1000);
    const tileSizePixels = calculateTileSizeInPixels(tileSizePercent, metrics, "center");
    const tileSize = Math.max(20, tileSizePixels);

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ —Ü–µ–Ω—Ç—Ä–µ –æ–±–ª–∞—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const centerX = metrics.timeColWidth + metrics.contentWidth / 2;
    const centerY = metrics.dayHeadHeight + metrics.contentHeight / 2;
    const halfSize = tileSize / 2;

    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é, —á—Ç–æ–±—ã –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    let left = centerX - halfSize;
    let top = centerY - halfSize;

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –æ–±–ª–∞—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const leftBoundary = metrics.timeColWidth;
    const rightBoundary = metrics.timeColWidth + metrics.contentWidth;
    const topBoundary = metrics.dayHeadHeight;
    const bottomBoundary = metrics.dayHeadHeight + metrics.contentHeight;

    if (left < leftBoundary) left = leftBoundary;
    if (left + tileSize > rightBoundary) left = rightBoundary - tileSize;
    if (top < topBoundary) top = topBoundary;
    if (top + tileSize > bottomBoundary) top = bottomBoundary - tileSize;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏ –ø–æ–∑–∏—Ü–∏—é
    logoMark.style.cssText = `
      position: absolute;
      pointer-events: none;
      z-index: 1;
      opacity: ${opacityValue};
      width: ${tileSize}px;
      height: ${tileSize}px;
      left: ${left}px;
      top: ${top}px;
      transform: rotate(${rotation}deg);
    `;

    if (recolor && variant === 3) {
      logoMark.style.backgroundColor = color;
      logoMark.style.webkitMaskImage = `url(${src})`;
      logoMark.style.maskImage = `url(${src})`;
      logoMark.style.webkitMaskRepeat = 'no-repeat';
      logoMark.style.maskRepeat = 'no-repeat';
      logoMark.style.webkitMaskPosition = 'center';
      logoMark.style.maskPosition = 'center';
      logoMark.style.webkitMaskSize = 'contain';
      logoMark.style.maskSize = 'contain';
      logoMark.style.backgroundImage = 'none';
    } else {
      logoMark.style.backgroundImage = `url(${src})`;
      logoMark.style.backgroundRepeat = 'no-repeat';
      logoMark.style.backgroundPosition = 'center';
      logoMark.style.backgroundSize = 'contain';
    }

  } else if (layout === "tile" || layout === "diagonal") {
    // –ü–ª–∏—Ç–æ—á–Ω—ã–µ —Ä–µ–∂–∏–º—ã
    const tileSize = Math.max(20, Math.min(1000, Number(lg.tileSize) || 140));
    const horizontalGap = Number(lg.horizontalGap || 180);
    const verticalGap = Number(lg.verticalGap || 180);

    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤ –æ–±–ª–∞—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    logoMark.style.cssText = `
      position: absolute;
      pointer-events: none;
      z-index: 1;
      opacity: ${opacityValue};
      left: ${metrics.timeColWidth}px;
      top: ${metrics.dayHeadHeight}px;
      width: ${metrics.contentWidth}px;
      height: ${metrics.contentHeight}px;
    `;

    // –ü–æ–ª—É—á–∞–µ–º data URL –¥–ª—è –ø–ª–∏—Ç–∫–∏
    const src = window.getTileSrc(
      variant,
      tileSize,
      horizontalGap,
      verticalGap,
      rotation,
      layout,
      recolor ? color : null,
      lg.opacity
    );

    if (recolor && variant === 3) {
      logoMark.style.backgroundColor = color;
      logoMark.style.webkitMaskImage = `url(${src})`;
      logoMark.style.maskImage = `url(${src})`;
      logoMark.style.webkitMaskRepeat = 'repeat';
      logoMark.style.maskRepeat = 'repeat';
    } else {
      logoMark.style.backgroundImage = `url(${src})`;
      logoMark.style.backgroundRepeat = 'repeat';
    }

    // –†–∞–∑–º–µ—Ä –ø–∞—Ç—Ç–µ—Ä–Ω–∞
    if (layout === "diagonal") {
      logoMark.style.backgroundSize = `${(tileSize + horizontalGap) * 2}px ${(tileSize + verticalGap) * 2}px`;
      if (recolor && variant === 3) {
        logoMark.style.webkitMaskSize = `${(tileSize + horizontalGap) * 2}px ${(tileSize + verticalGap) * 2}px`;
        logoMark.style.maskSize = `${(tileSize + horizontalGap) * 2}px ${(tileSize + verticalGap) * 2}px`;
      }
    } else {
      logoMark.style.backgroundSize = `${tileSize + horizontalGap}px ${tileSize + verticalGap}px`;
      if (recolor && variant === 3) {
        logoMark.style.webkitMaskSize = `${tileSize + horizontalGap}px ${tileSize + verticalGap}px`;
        logoMark.style.maskSize = `${tileSize + horizontalGap}px ${tileSize + verticalGap}px`;
      }
    }

    // –°–º–µ—â–µ–Ω–∏–µ
    const offsetX = Number(lg.tileOffsetX || 0);
    const offsetY = Number(lg.tileOffsetY || 0);
    logoMark.style.backgroundPosition = `${offsetX}px ${offsetY}px`;

    if (recolor && variant === 3) {
      logoMark.style.webkitMaskPosition = `${offsetX}px ${offsetY}px`;
      logoMark.style.maskPosition = `${offsetX}px ${offsetY}px`;
    }
  }

  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
  layer.style.display = 'block';
  logoMark.style.display = 'block';
}

function ensureLogoLayer() {
  const scheduleWrap = document.querySelector(".schedule-wrap");
  if (!scheduleWrap) return null;

  let layer = $("logoLayer");
  if (!layer) {
    layer = document.createElement("div");
    layer.id = "logoLayer";
    layer.setAttribute("aria-hidden", "true");
    layer.style.display = "none";
    scheduleWrap.appendChild(layer);
  }

  let mark = $("logoMark");
  if (!mark) {
    mark = document.createElement("div");
    mark.id = "logoMark";
    mark.setAttribute("aria-hidden", "true");
    layer.appendChild(mark);
  }

  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ .schedule-wrap –∏–º–µ–µ—Ç position: relative
  if (scheduleWrap.style.position !== "relative") {
    scheduleWrap.style.position = "relative";
  }

  return layer;
}

function getScheduleMetrics(context = document) {
  const schedule = context.querySelector('.schedule');
  if (!schedule) {
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–ª–∏ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π
    const computedStyle = getComputedStyle(document.documentElement);
    const timeColWidth = parseFloat(computedStyle.getPropertyValue('--timeCol')) || 76;
    const dayHeadHeight = 42; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–Ω–µ–π

    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã —á–µ—Ä–µ–∑ –∑–∞–ø—Ä–æ—Å –≤ DOM
    let scheduleWidth = 0;
    let scheduleHeight = 0;
    const scheduleWrap = context.querySelector('.schedule-wrap');
    if (scheduleWrap) {
      scheduleWidth = scheduleWrap.scrollWidth || scheduleWrap.offsetWidth;
      scheduleHeight = scheduleWrap.scrollHeight || scheduleWrap.offsetHeight;
    }

    const contentWidth = Math.max(0, scheduleWidth - timeColWidth);
    const contentHeight = Math.max(0, scheduleHeight - dayHeadHeight);

    console.log('Schedule not found, using computed metrics:', {
      timeColWidth,
      dayHeadHeight,
      scheduleWidth,
      scheduleHeight,
      contentWidth,
      contentHeight
    });

    return {
      timeColWidth,
      dayHeadHeight,
      scheduleWidth,
      scheduleHeight,
      contentWidth,
      contentHeight
    };
  }

  // –ò—â–µ–º –∫–æ–ª–æ–Ω–∫—É –≤—Ä–µ–º–µ–Ω–∏
  let timeColWidth = 76;
  const timeCell = schedule.querySelector('.cell.time');
  if (timeCell) {
    const rect = timeCell.getBoundingClientRect();
    timeColWidth = rect.width;
  } else {
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∫–æ–ª–æ–Ω–∫—É –≤—Ä–µ–º–µ–Ω–∏, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    const computedStyle = getComputedStyle(schedule);
    const cssWidth = parseFloat(computedStyle.getPropertyValue('--timeCol')) || 76;
    timeColWidth = cssWidth;
  }

  // –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è
  let dayHeadHeight = 42;
  const headCell = schedule.querySelector('.cell.head');
  if (headCell) {
    const rect = headCell.getBoundingClientRect();
    dayHeadHeight = rect.height;
  }

  // –ü–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∏ –≤—ã—Å–æ—Ç–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
  let scheduleWidth, scheduleHeight;

  // –î–ª—è compact —Ä–µ–∂–∏–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤
  if (schedule.classList.contains('compact-mode')) {
    const cells = schedule.querySelectorAll('.cell.droppable');
    if (cells.length > 0) {
      const firstCell = cells[0];
      const cellRect = firstCell.getBoundingClientRect();
      scheduleWidth = cellRect.width * 7; // 7 –¥–Ω–µ–π
      // –í—ã—á–∏—Å–ª—è–µ–º –≤—ã—Å–æ—Ç—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
      scheduleHeight = schedule.scrollHeight;
    } else {
      scheduleWidth = schedule.scrollWidth;
      scheduleHeight = schedule.scrollHeight;
    }
  } else {
    scheduleWidth = schedule.scrollWidth;
    scheduleHeight = schedule.scrollHeight;
  }

  // –®–∏—Ä–∏–Ω–∞ –∏ –≤—ã—Å–æ—Ç–∞ –æ–±–ª–∞—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤)
  const contentWidth = Math.max(0, scheduleWidth - timeColWidth);
  const contentHeight = Math.max(0, scheduleHeight - dayHeadHeight);

  const metrics = {
    timeColWidth,
    dayHeadHeight,
    scheduleWidth,
    scheduleHeight,
    contentWidth,
    contentHeight
  };

  console.log('Schedule metrics calculated:', metrics);

  return metrics;
}

function getLogoVariant() {
  const variant = state.settings.logo?.variant;
  if (variant === 3 && !state.settings.logo.uploadedFileData) {
    return 1;
  }
  return clamp(Math.round(Number(variant ?? 1)), 1, 3);
}

const defaultState =
  typeof DEFAULT_STATE === "function" ? DEFAULT_STATE() : DEFAULT_STATE;

function DEFAULT_STATE() {
  return {
    version: 13,
    settings: {
      schedule: {
        start: "08:00",
        end: "22:00",
        slotMinutes: 60,
        slotHeight: 72,
        snapMinutes: 5,
        maxPerCell: 2,
        defaultDuration: 60,
      },
      display: {
        cellView: "timeline",
        cardMode: "namecoachroom",
        showNotes: true,
        showEmptyHint: true,
        showDayView: false,
        showTodayHighlight: true,
        dayWidthPx: 0,
        cellPadPx: 6,
      },
      font: {
        preset: "custom",
        tightness: "normal",
        titleFamily: "system",
        metaFamily: "system",
        family: "system",
        lineHeight: 1.12,
        titleSize1: 12,
        titleSize2: 10,
        metaSize1: 11,
        metaSize2: 9,
        weightTitle: 900,
        weightMeta: 600,
        sampleText: "(—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ / –†–ê–°–ü–ò–°–ê–ù–ò–ï)",
        letterSpacing: 0,
        textTransform: "none",
        titleClamp: 3,
        cardPadY: 7,
        cardRadius: 12,
      },
      theme: {
        mode: "auto",
        customTokens: deepCopy(THEME_PRESETS[0].tokens),
        alpha: { today: 60, now: 65, event: 100, shadow: 10 },
      },
      logo: {
        enabled: false,
        variant: 1,
        opacity: LOGO_CONSTANTS.DEFAULT_OPACITY,
        recolor: false,
        color: LOGO_CONSTANTS.DEFAULT_COLOR,
        layout: LOGO_CONSTANTS.DEFAULT_LAYOUT,
        tileSize: LOGO_CONSTANTS.DEFAULT_TILE_SIZE,
        horizontalGap: LOGO_CONSTANTS.DEFAULT_GAP,
        verticalGap: LOGO_CONSTANTS.DEFAULT_GAP,
        rotation: LOGO_CONSTANTS.DEFAULT_ROTATION,
        tileOffsetX: LOGO_CONSTANTS.DEFAULT_OFFSET,
        tileOffsetY: LOGO_CONSTANTS.DEFAULT_OFFSET,
        uploadedFileData: null,
      },
    },
    directions: [
      { id: "yoga", name: "–ô–æ–≥–∞", color: "#ef4444" },
      { id: "pilates", name: "–ü–∏–ª–∞—Ç–µ—Å", color: "#14b8a6" },
      { id: "crossfit", name: "–ö—Ä–æ—Å—Å—Ñ–∏—Ç", color: "#0ea5e9" },
    ],
    coaches: ["–ê–Ω–Ω–∞", "–î–º–∏—Ç—Ä–∏–π", "–ï–ª–µ–Ω–∞"],
    events: [],
  };
}

function clamp(value, min, max) {
  return Math.min(Math.max(value, min), max);
}

window._tileBlobCache = window._tileBlobCache || new Map();

// –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
window.clearTileBlobCache = function clearTileBlobCache() {
  for (const blobUrl of window._tileBlobCache.values()) {
    try {
      URL.revokeObjectURL(blobUrl);
    } catch { }
  }
  window._tileBlobCache.clear();
};

function getLogoUrlByVariant(variant, recolorColor = null) {
  variant = Number(variant);

  // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —Ü–≤–µ—Ç –¥–ª—è –ø–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞–Ω–∏—è –∏ —ç—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø (1 –∏–ª–∏ 2)
  if (recolorColor && (variant === 1 || variant === 2)) {
    const cacheKey = `${variant}_${recolorColor}`;
    if (!window._logoSvgBlobUrls) window._logoSvgBlobUrls = {};

    if (!window._logoSvgBlobUrls[cacheKey]) {
      let svgString;
      if (variant === 1) {
        // –ü—Ä–æ—Å—Ç–æ–π –∫—Ä—É–≥ - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–∞–ª–∏–¥–Ω—ã–π SVG
        svgString = `<?xml version="1.0" encoding="UTF-8"?>
        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" fill="${recolorColor}" stroke="none"/>
        </svg>`;
      } else if (variant === 2) {
        // –ü—Ä–æ—Å—Ç–æ–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
        svgString = `<?xml version="1.0" encoding="UTF-8"?>
        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
          <rect x="10" y="10" width="80" height="80" rx="10" fill="${recolorColor}" stroke="none"/>
        </svg>`;
      }

      if (svgString) {
        const blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
        window._logoSvgBlobUrls[cacheKey] = URL.createObjectURL(blob);
      }
    }
    return window._logoSvgBlobUrls[cacheKey] || getLogoUrlByVariant(variant);
  }

  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∑–∞–∫—Ä–∞—à–µ–Ω–Ω—ã—Ö –ª–æ–≥–æ—Ç–∏–ø–æ–≤
  if (!window._logoSvgBlobUrls) window._logoSvgBlobUrls = {};

  // –°–æ–∑–¥–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ SVG –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–æ–≤ 1 –∏ 2
  if (!window._logoSvgBlobUrls[1]) {
    const svg1 = `<?xml version="1.0" encoding="UTF-8"?>
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="45" fill="#000000" stroke="none"/>
    </svg>`;
    const blob1 = new Blob([svg1], { type: "image/svg+xml;charset=utf-8" });
    window._logoSvgBlobUrls[1] = URL.createObjectURL(blob1);
  }

  if (!window._logoSvgBlobUrls[2]) {
    const svg2 = `<?xml version="1.0" encoding="UTF-8"?>
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
      <rect x="10" y="10" width="80" height="80" rx="10" fill="#000000" stroke="none"/>
    </svg>`;
    const blob2 = new Blob([svg2], { type: "image/svg+xml;charset=utf-8" });
    window._logoSvgBlobUrls[2] = URL.createObjectURL(blob2);
  }

  // –î–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ 3 –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
  if (variant === 3) {
    const fileData = state.settings.logo?.uploadedFileData;
    if (fileData && (fileData.startsWith("data:") || fileData.startsWith("blob:"))) {
      return fileData;
    } else {
      console.warn('–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–≥–æ—Ç–∏–ø 1');
      return window._logoSvgBlobUrls[1];
    }
  }

  return window._logoSvgBlobUrls[variant] || window._logoSvgBlobUrls[1];
}

function calculateTileSizeInPixels(percent, metrics, layout) {
  // –û–ì–†–ê–ù–ò–ß–ò–í–ê–ï–ú –ü–†–û–¶–ï–ù–¢
  const safePercent = clamp(Number(percent), 0, 1000);

  // –ï—Å–ª–∏ –Ω–µ—Ç –º–µ—Ç—Ä–∏–∫, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
  if (!metrics || !metrics.contentWidth || !metrics.contentHeight) {
    const defaultPixelSize = Math.round((safePercent / 100) * 300);
    return Math.max(20, defaultPixelSize);
  }

  // –î–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É –æ–±–ª–∞—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  if (layout === "center" || layout === "stamp") {
    const minContentDimension = Math.min(metrics.contentWidth, metrics.contentHeight);
    const pixelSize = Math.round((safePercent / 100) * minContentDimension);
    return Math.max(20, pixelSize);
  }

  // –î–ª—è –ø–ª–∏—Ç–æ—á–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —à–∏—Ä–∏–Ω—É –æ–±–ª–∞—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  const pixelSize = Math.round((safePercent / 100) * metrics.contentWidth);
  return Math.max(20, pixelSize);
}

window.getTileSrc = function getTileSrc(
  variant,
  tileSize = 50,
  horizontalGap = 0,
  verticalGap = 0,
  rotation = 0,
  layout = "tile",
  recolorColor = null,
  opacity = 100  // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
) {
  variant = Number(variant);

  // –ü–æ–ª—É—á–∞–µ–º data URL –ª–æ–≥–æ—Ç–∏–ø–∞ —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
  const logoDataUrl = getLogoDataUrl(variant, recolorColor, opacity);

  // –ö–ª—é—á –¥–ª—è –∫—ç—à–∞ —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç opacity
  const key = `${variant}|${tileSize}|${horizontalGap}|${verticalGap}|${rotation}|${layout}|${recolorColor}|${opacity}`;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
  if (window._tileBlobCache && window._tileBlobCache.get(key)) {
    return window._tileBlobCache.get(key);
  }

  let svg;

  if (layout === "diagonal") {
    // –î–ò–ê–ì–û–ù–ê–õ–¨–ù–´–ô –†–ï–ñ–ò–ú
    const cellW = tileSize + horizontalGap;
    const cellH = tileSize + verticalGap;

    svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${cellW * 2}" height="${cellH * 2}" viewBox="0 0 ${cellW * 2} ${cellH * 2}">
      <defs>
        <pattern id="pattern${key}" patternUnits="userSpaceOnUse" width="${cellW * 2}" height="${cellH * 2}">
          <g transform="translate(${cellW / 2}, ${cellH / 2}) rotate(${rotation}) translate(${-tileSize / 2}, ${-tileSize / 2})">
            <image href="${logoDataUrl}" width="${tileSize}" height="${tileSize}" preserveAspectRatio="xMidYMid meet"/>
          </g>
          <g transform="translate(${cellW * 1.5}, ${cellH * 1.5}) rotate(${rotation}) translate(${-tileSize / 2}, ${-tileSize / 2})">
            <image href="${logoDataUrl}" width="${tileSize}" height="${tileSize}" preserveAspectRatio="xMidYMid meet"/>
          </g>
        </pattern>
      </defs>
      <rect width="100%" height="100%" fill="url(#pattern${key})"/>
    </svg>`;
  } else {
    // –û–ë–´–ß–ù–´–ô –ü–õ–ò–¢–û–ß–ù–´–ô –†–ï–ñ–ò–ú
    const cellW = tileSize + horizontalGap;
    const cellH = tileSize + verticalGap;

    svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${cellW}" height="${cellH}" viewBox="0 0 ${cellW} ${cellH}">
      <defs>
        <pattern id="pattern${key}" patternUnits="userSpaceOnUse" width="${cellW}" height="${cellH}">
          <g transform="translate(${cellW / 2}, ${cellH / 2}) rotate(${rotation}) translate(${-tileSize / 2}, ${-tileSize / 2})">
            <image href="${logoDataUrl}" width="${tileSize}" height="${tileSize}" preserveAspectRatio="xMidYMid meet"/>
          </g>
        </pattern>
      </defs>
      <rect width="100%" height="100%" fill="url(#pattern${key})"/>
    </svg>`;
  }

  // –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  const dataUrl = `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svg)))}`;
  if (window._tileBlobCache) {
    window._tileBlobCache.set(key, dataUrl);
  }

  return dataUrl;
};


function updateLogoAndSave() {
  console.log("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ—Ç–∏–ø–∞...");

  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø
  applyLogo();

  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
  syncLogoPreview();

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  scheduleAutoSave("logo updated");

  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  setTimeout(() => {
    markGeometryDirty();
  }, 100);
}

function markGeometryDirtyIfNeeded() {
  const key = getGeomKey();
  if (key === lastGeomKey) return;
  lastGeomKey = key;
  markGeometryDirty();
}

function getGeomKey() {
  const d = state.settings.display;
  const s = state.settings.schedule;
  const f = state.settings.font;

  return [
    d.cellView,
    d.dayWidthPx ?? 0,
    d.cellPadPx ?? 6,
    s.slotHeight ?? 72,

    f.family,
    f.titleFamily,
    f.metaFamily,

    f.lineHeight,
    f.titleSize1,
    f.titleSize2,
    f.metaSize1,
    f.metaSize2,
    f.weightTitle,
    f.weightMeta,
  ].join("|");
}

function markGeometryDirty() {
  if (geometryDirty) return;
  geometryDirty = true;

  if (geometryRafId) cancelAnimationFrame(geometryRafId);
  geometryRafId = requestAnimationFrame(() => {
    geometryDirty = false;
    geometryRafId = null;
    performGeometrySync();
  });
}

function syncLogoPreview() {
  const lg = state.settings.logo || {};
  const previewContainer = $("logoPreviewContainer");

  if (!previewContainer) return;

  // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
  let preview = previewContainer.querySelector(".logo-preview");
  if (!preview) {
    preview = document.createElement("div");
    preview.className = "logo-preview";
    previewContainer.appendChild(preview);
  }

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏
  preview.style.cssText = '';

  if (!lg.enabled) {
    preview.style.display = 'none';
    return;
  }

  preview.style.display = 'block';

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ tileSize
  const tileSize = clamp(Math.round(Number(lg.tileSize) || 30), 0, 100);
  const previewSize = 100; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –ø—Ä–µ–≤—å—é –≤ –ø–∏–∫—Å–µ–ª—è—Ö

  preview.style.width = `${previewSize}px`;
  preview.style.height = `${previewSize}px`;

  // –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ü–†–û–ó–†–ê–ß–ù–û–°–¢–¨
  const opacityValue = Number(lg.opacity || 12) / 100;
  preview.style.opacity = `${opacityValue}`;

  const layout = String(lg.layout || "center");
  const variant = getLogoVariant();

  // –ü–æ–ª—É—á–∞–µ–º URL –ª–æ–≥–æ—Ç–∏–ø–∞
  const src = getLogoDataUrl(variant, lg.recolor ? lg.color : null);

  if (layout === "center") {
    // –î–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ - contain –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
    preview.style.backgroundImage = `url(${src})`;
    preview.style.backgroundRepeat = "no-repeat";
    preview.style.backgroundSize = "contain";
    preview.style.backgroundPosition = "center center";

    if (lg.recolor && variant === 3) {
      preview.style.backgroundColor = lg.color || "#0ea5e9";
      preview.style.webkitMaskImage = `url(${src})`;
      preview.style.maskImage = `url(${src})`;
      preview.style.webkitMaskSize = "contain";
      preview.style.maskSize = "contain";
      preview.style.webkitMaskRepeat = "no-repeat";
      preview.style.maskRepeat = "no-repeat";
      preview.style.webkitMaskPosition = "center center";
      preview.style.maskPosition = "center center";
      preview.style.backgroundImage = "none";
    }
  } else if (layout === "tile" || layout === "diagonal") {
    // –î–ª—è –ø–ª–∏—Ç–æ—á–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ–º tile pattern
    const tileSizePx = Math.max(20, Math.min(100, tileSize));
    const horizontalGap = Number(lg.horizontalGap || 180);
    const verticalGap = Number(lg.verticalGap || 180);

    const tileSrc = window.getTileSrc(
      variant,
      tileSizePx,
      horizontalGap,
      verticalGap,
      lg.rotation || 0,
      layout,
      lg.recolor ? lg.color : null
    );

    preview.style.backgroundImage = `url(${tileSrc})`;
    preview.style.backgroundRepeat = "repeat";
    preview.style.backgroundSize = `${tileSizePx}px ${tileSizePx}px`;
  }
}

function performGeometrySync() {
  const view = state.settings.display.cellView;
  const scheduleEl = $("schedule");
  if (!scheduleEl) return;

  if (view === "list") return;

  if (view === "compact") {
    const allCells = Array.from(scheduleEl.querySelectorAll(".cell.droppable"));
    if (!allCells.length) return;

    const allCards = Array.from(
      scheduleEl.querySelectorAll(".event.compact-card"),
    );

    const fragment = document.createDocumentFragment();

    const measurements = {
      cards: [],
      cells: [],
    };

    allCards.forEach((card) => {
      card.style.removeProperty("height");
      card.style.removeProperty("min-height");
      measurements.cards.push({
        element: card,
        height: 0,
      });
    });

    allCells.forEach((cell) => {
      cell.style.removeProperty("height");
      cell.style.removeProperty("min-height");
      measurements.cells.push({
        element: cell,
        scrollHeight: 0,
        padding: 0,
      });
    });

    requestAnimationFrame(() => {
      if (state.settings.display.cellView !== "compact") return;

      let maxCardH = 0;
      measurements.cards.forEach((item) => {
        const h = item.element.getBoundingClientRect().height;
        item.height = h;
        if (h > maxCardH) maxCardH = h;
      });

      const cardH = Math.max(Math.ceil(maxCardH), 60) + "px";

      measurements.cards.forEach((item) => {
        item.element.style.setProperty("height", cardH, "important");
      });

      requestAnimationFrame(() => {
        let maxCellH = 0;
        measurements.cells.forEach((item) => {
          const cs = getComputedStyle(item.element);
          const padY =
            (parseFloat(cs.paddingTop) || 0) +
            (parseFloat(cs.paddingBottom) || 0);

          const inner = item.element.querySelector(".slot-inner");
          const contentH = inner
            ? inner.scrollHeight
            : item.element.scrollHeight;
          const need = contentH + padY;

          if (need > maxCellH) maxCellH = need;
        });

        const cellH = Math.ceil(maxCellH) + "px";

        measurements.cells.forEach((item) => {
          item.element.style.height = cellH;
        });
      });
    });
    return;
  }

  scheduleEl.classList.add("measuring");

  requestAnimationFrame(() => {
    if (state.settings.display.cellView !== "timeline") {
      scheduleEl.classList.remove("measuring");
      return;
    }

    const cells = Array.from(scheduleEl.querySelectorAll(".cell.droppable"));
    if (!cells.length) {
      scheduleEl.classList.remove("measuring");
      return;
    }

    const widthMeasurements = [];
    const eventMeasurements = [];

    cells.forEach((c) => {
      c.style.removeProperty("height");
      c.style.removeProperty("min-height");

      const rect = c.getBoundingClientRect();
      widthMeasurements.push({
        element: c,
        width: rect.width,
      });
    });

    const events = Array.from(
      scheduleEl.querySelectorAll(".cell.droppable .event"),
    ).slice(0, 24);

    events.forEach((ev) => {
      const w = Math.max(ev.getBoundingClientRect().width, ev.scrollWidth);
      eventMeasurements.push(w);
    });

    const maxCellW = Math.max(...widthMeasurements.map((m) => m.width));
    const maxEventW = Math.max(...eventMeasurements);

    const rawW = Math.max(maxCellW, maxEventW);
    if (rawW > 0 && !(Number(state.settings.display?.dayWidthPx) > 0)) {
      const maxW = Math.min(320, Math.max(220, window.innerWidth - 120));
      const nextW = clamp(Math.ceil(rawW), 120, maxW);

      const cur =
        parseFloat(
          getComputedStyle(document.documentElement).getPropertyValue("--dayW"),
        ) || 0;

      if (!cur || Math.abs(cur - nextW) >= 4) {
        document.documentElement.style.setProperty("--dayW", nextW + "px");
      }
    }

    scheduleEl.classList.remove("measuring");
    scheduleEl.classList.add("measuring-h");

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        if (state.settings.display.cellView !== "timeline") {
          scheduleEl.classList.remove("measuring-h");
          return;
        }

        const cells2 = Array.from(
          scheduleEl.querySelectorAll(".cell.droppable"),
        );
        if (!cells2.length) {
          scheduleEl.classList.remove("measuring-h");
          return;
        }

        try {
          const rowHeights = new Map();

          cells2.forEach((c) => {
            c.style.removeProperty("height");
            c.style.removeProperty("min-height");
          });

          const rootCS = getComputedStyle(document.documentElement);
          const minRowH =
            parseFloat(rootCS.getPropertyValue("--slotH")) ||
            Number(state.settings.schedule?.slotHeight) ||
            72;

          cells2.forEach((c) => {
            const key = c.dataset.slotIndex;
            if (key == null) return;

            const cs = getComputedStyle(c);
            const padY =
              (parseFloat(cs.paddingTop) || 0) +
              (parseFloat(cs.paddingBottom) || 0);

            const slotEl = c.querySelector(".slot.tl-fill");
            const inner = c.querySelector(".slot-inner");

            let contentH = 0;

            if (slotEl?.classList.contains("two") && inner) {
              const evs = Array.from(inner.querySelectorAll(".event"));
              if (evs.length) {
                let maxEvH = 0;
                evs.forEach((el) => {
                  const h = el.getBoundingClientRect().height;
                  if (h > maxEvH) maxEvH = h;
                });

                const innerCS = getComputedStyle(inner);
                const gap = parseFloat(innerCS.rowGap || innerCS.gap) || 0;
                contentH = maxEvH * 2 + gap;
              } else {
                contentH = inner.scrollHeight;
              }
            } else {
              contentH = inner ? inner.scrollHeight : c.scrollHeight;
            }

            const need = Math.max(contentH + padY, minRowH);
            const prev = rowHeights.get(key) ?? 0;
            if (need > prev) rowHeights.set(key, need);
          });

          cells2.forEach((c) => {
            const key = c.dataset.slotIndex;
            if (key == null) return;

            const h = rowHeights.get(key);
            if (h) c.style.height = `${Math.ceil(h)}px`;
          });
        } finally {
          scheduleEl.classList.remove("measuring-h");
        }
      });
    });
  });
}

window.getLogoDataUrl = function getLogoDataUrl(variant, recolorColor = null, opacity = 100) {
  variant = Number(variant);
  
  if (variant === 3) {
    const fileData = state.settings.logo?.uploadedFileData;
    if (fileData && fileData.startsWith("data:")) {
      if (recolorColor || opacity < 100) {
        const base64 = fileData.split(',')[1];
        let svgText = atob(base64);
        
        if (recolorColor && fileData.includes("image/svg+xml")) {
          svgText = svgText.replace(/(fill|stroke)="[^"]*"/g, `$1="${recolorColor}"`);
        }
        
        if (opacity < 100) {
          const opacityValue = opacity / 100;
          const svgStart = svgText.indexOf('<svg');
          if (svgStart !== -1) {
            const svgEnd = svgText.indexOf('>', svgStart);
            const svgTag = svgText.substring(svgStart, svgEnd + 1);
            
            if (svgTag.includes('style="')) {
              svgText = svgText.replace(/style="([^"]*)"/, `style="$1;opacity:${opacityValue}"`);
            } else {
              svgText = svgText.replace(svgTag, svgTag.replace('>', ` style="opacity:${opacityValue}">`));
            }
          }
        }
        
        return `data:image/svg+xml;base64,${btoa(svgText)}`;
      }
      return fileData;
    }
    variant = 1;
  }
  
  let svgString;
  if (variant === 1) {
    svgString = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="currentColor"/></svg>';
  } else if (variant === 2) {
    svgString = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" rx="15" fill="currentColor"/></svg>';
  } else {
    svgString = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="currentColor"/></svg>';
  }
  
  if (recolorColor && (variant === 1 || variant === 2)) {
    svgString = svgString.replace(/fill="currentColor"/g, `fill="${recolorColor}"`);
  }
  
  if (opacity < 100 && (variant === 1 || variant === 2)) {
    const opacityValue = opacity / 100;
    if (variant === 1) {
      svgString = svgString.replace('<circle ', `<circle style="opacity:${opacityValue}" `);
    } else if (variant === 2) {
      svgString = svgString.replace('<rect ', `<rect style="opacity:${opacityValue}" `);
    }
  }
  
  const base64 = btoa(unescape(encodeURIComponent(svgString)));
  return `data:image/svg+xml;base64,${base64}`;
};

function scheduleAutoSave(reason) {
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(() => {
    saveState();
    showSaveIndicator();
    if (reason) console.log(`Auto-save: ${reason}`);
  }, 2000);
}

function showSaveIndicator() {
  const oldIndicator = document.querySelector(".save-indicator");
  if (oldIndicator) {
    oldIndicator.remove();
  }

  if (!saveIndicatorStyleAdded) {
    const style = document.createElement("style");
    style.textContent = `
      @keyframes fadeOut {
        0% { opacity: 1; }
        70% { opacity: 1; }
        100% { opacity: 0; transform: translateY(10px); }
      }
    `;
    document.head.appendChild(style);
    saveIndicatorStyleAdded = true;
  }

  const indicator = document.createElement("div");
  indicator.className = "save-indicator show";
  indicator.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ";
  indicator.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--accent);
    color: var(--accentText);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: fadeOut 2s forwards;
  `;

  document.body.appendChild(indicator);

  setTimeout(() => {
    if (indicator.parentNode) {
      indicator.remove();
    }
  }, 2000);
}

function saveState(silent = false) {
  if (isSaving) {
    console.warn("‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è");
    return;
  }

  if (!isLocalStorageAvailable()) {
    toast(
      "WARN",
      "‚ö†Ô∏è",
      "–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.",
      3000,
    );
    isSaving = false;
    return;
  }

  isSaving = true;

  try {
    state.version = 13;

    const json = JSON.stringify(state, null, 2);

    if (json.length > 4500000) {
      if (compressAndSave(json)) {
        console.log("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (—Å–æ —Å–∂–∞—Ç–∏–µ–º)");
      } else {
        toast("ERR", "‚ùå", "–î–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", 3000);
        isSaving = false;
        return;
      }
    } else {
      localStorage.setItem(STORAGE_KEY, json);
    }

    createBackup(json);

    clearOldBackups();

    lastSaveTime = Date.now();

    if (!silent) {
      showSaveIndicator();
    }
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);

    if (e.name === "QuotaExceededError") {
      handleStorageFull();
    } else if (e.name === "SecurityError") {
      toast(
        "ERR",
        "üîí",
        "–î–æ—Å—Ç—É–ø –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â—É –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞",
        5000,
      );
    } else {
      toast("ERR", "‚ùå", "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message, 3000);
    }
  } finally {
    isSaving = false;
  }
}

function compressAndSave(json) {
  try {
    const compressed = json.replace(/\s+/g, " ");
    if (compressed.length <= 4500000) {
      localStorage.setItem(STORAGE_KEY, compressed);
      console.log("–î–∞–Ω–Ω—ã–µ —Å–∂–∞—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
      return true;
    }

    const stateCopy = deepCopy(state);
    const backupSettings = deepCopy(state.settings);
    stateCopy.settings = { version: stateCopy.version };

    const minimalJson = JSON.stringify({
      version: stateCopy.version,
      events: stateCopy.events,
      directions: stateCopy.directions,
      coaches: stateCopy.coaches,
    });

    if (minimalJson.length <= 4500000) {
      localStorage.setItem(STORAGE_KEY, minimalJson);

      state.settings = backupSettings;
      console.log("–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
      return true;
    }

    return false;
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ —Å–∂–∞—Ç–∏—è:", e);
    return false;
  }
}

function isLocalStorageAvailable() {
  try {
    const test = "__storage_test__";
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch (e) {
    return false;
  }
}

function createBackup(json) {
  try {
    const backupKey = `${STORAGE_KEY}_backup_${Date.now()}`;
    sessionStorage.setItem(backupKey, json);

    const backups = [];
    for (let i = 0; i < sessionStorage.length; i++) {
      const key = sessionStorage.key(i);
      if (key.startsWith(`${STORAGE_KEY}_backup_`)) {
        backups.push({ key, time: parseInt(key.split("_").pop()) });
      }
    }

    backups.sort((a, b) => b.time - a.time);
    backups.slice(3).forEach((backup) => {
      sessionStorage.removeItem(backup.key);
    });
  } catch (e) {
    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é:", e);
  }
}

function clearOldBackups() {
  try {
    const backups = [];

    for (let i = 0; i < sessionStorage.length; i++) {
      const key = sessionStorage.key(i);
      if (key.startsWith(`${STORAGE_KEY}_backup_`)) {
        const time = parseInt(key.split("_").pop());
        if (!isNaN(time)) {
          backups.push({ key, time });
        }
      }
    }

    backups.sort((a, b) => b.time - a.time);

    const toRemove = backups.slice(3);

    toRemove.forEach((backup) => {
      sessionStorage.removeItem(backup.key);
    });

    if (toRemove.length > 0) {
      console.log(`–£–¥–∞–ª–µ–Ω–æ ${toRemove.length} —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π`);
    }
  } catch (e) {
    console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π:", e);
  }
}
// T
function handleStorageFull() {
  toast(
    "ERR",
    "‚õî",
    "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è –∏–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ.",
    5000,
  );

  setTimeout(() => {
    showStorageCleanupPrompt();
  }, 1000);
}

function showStorageCleanupPrompt() {
  const modal = document.createElement("div");
  modal.className = "backdrop show";
  modal.innerHTML = `
    <div class="modal" style="max-width:500px">
      <header class="modal-head">
        <h2>–û—á–∏—Å—Ç–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞</h2>
        <button class="ghost" onclick="this.closest('.backdrop').remove()">√ó</button>
      </header>
      <div class="modal-body">
        <p>LocalStorage –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</p>
        <div style="display:flex; flex-direction:column; gap:10px; margin:15px 0">
          <button class="primary" id="exportAllBtn">üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë –≤ JSON</button>
          <button id="clearOldBtn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è (–±–æ–ª—å—à–µ –º–µ—Å—è—Ü–∞)</button>
          <button class="danger" id="clearAllBtn">‚ö†Ô∏è –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (—Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)</button>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  modal.querySelector("#exportAllBtn").addEventListener("click", () => {
    exportJson();
    modal.remove();
  });

  modal.querySelector("#clearOldBtn").addEventListener("click", () => {
    clearOldEvents();
    modal.remove();
  });

  modal.querySelector("#clearAllBtn").addEventListener("click", () => {
    if (confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–Ω—è—Ç–∏—è? –°–æ—Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.")) {
      state.events = [];
      saveState();
      renderAll();
      toast("OK", "–û—á–∏—â–µ–Ω–æ", "–í—Å–µ –∑–∞–Ω—è—Ç–∏—è —É–¥–∞–ª–µ–Ω—ã");
    }
    modal.remove();
  });
}

function deepCopy(o) {
  return JSON.parse(JSON.stringify(o));
}


function clearOldEvents() {
  const monthAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
  const oldCount = state.events.length;

  state.events = state.events.filter((ev) => {
    const eventTime = ev.createdAt || 0;
    return eventTime > monthAgo;
  });

  const removed = oldCount - state.events.length;
  saveState();
  renderAll();
  toast("OK", "–û—á–∏—â–µ–Ω–æ", `–£–¥–∞–ª–µ–Ω–æ ${removed} —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π`);
}

function updateLogoIfNeeded() {
  const lg = state.settings.logo || {};
  const currentState = JSON.stringify({
    enabled: lg.enabled,
    variant: lg.variant,
    opacity: lg.opacity,
    recolor: lg.recolor,
    color: lg.color,
    layout: lg.layout,
    tileSize: lg.tileSize,
    horizontalGap: lg.horizontalGap,
    verticalGap: lg.verticalGap,
    rotation: lg.rotation,
    tileOffsetX: lg.tileOffsetX,
    tileOffsetY: lg.tileOffsetY,
    uploadedFileData: lg.uploadedFileData, // –≤–∞–∂–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
  });

  if (currentState !== lastLogoState) {
    lastLogoState = currentState;
    applyLogo();
  }
}

function setupLogoNumberInputs() {
  console.log("Setting up logo number inputs...");

  // –°–ª–∞–π–¥–µ—Ä —Ä–∞–∑–º–µ—Ä–∞ –ø–ª–∏—Ç–∫–∏
  if (logoTileSize) {
    logoTileSize.addEventListener("input", () => {
      console.log("logoTileSize slider changed:", logoTileSize.value);
      const value = clamp(Math.round(Number(logoTileSize.value || 140)), 20, 1000);
      state.settings.logo.tileSize = value;

      // –û–±–Ω–æ–≤–ª—è–µ–º —á–∏—Å–ª–æ–≤–æ–µ –ø–æ–ª–µ
      if (logoTileSizeNum) {
        logoTileSizeNum.value = value;
      }

      updateLogoAndSave();
    });
  }

  // –†–∞–∑–º–µ—Ä –ø–ª–∏—Ç–∫–∏
  if (logoTileSizeNum) {
    logoTileSizeNum.addEventListener("input", function () {
      console.log("logoTileSizeNum changed:", this.value);
      const value = clamp(Math.round(Number(this.value || 140)), 20, 1000);
      state.settings.logo.tileSize = value;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä
      if (logoTileSize) {
        logoTileSize.value = value;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–æ—Ç–∏–ø
      updateLogoAndSave();
    });
  }

  // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –∑–∞–∑–æ—Ä
  if (logoHorizontalGapNum) {
    logoHorizontalGapNum.addEventListener("input", function () {
      console.log("logoHorizontalGapNum changed:", this.value);
      const value = clamp(Math.round(Number(this.value || 180)), 0, 800);
      state.settings.logo.horizontalGap = value;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä
      if (logoHorizontalGap) {
        logoHorizontalGap.value = value;
      }

      if (logoHorizontalGapVal) {
        logoHorizontalGapVal.textContent = `${value}px`;
      }

      updateLogoAndSave();
    });
  }

  // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –∑–∞–∑–æ—Ä
  if (logoVerticalGapNum) {
    logoVerticalGapNum.addEventListener("input", function () {
      console.log("logoVerticalGapNum changed:", this.value);
      const value = clamp(Math.round(Number(this.value || 180)), 0, 800);
      state.settings.logo.verticalGap = value;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä
      if (logoVerticalGap) {
        logoVerticalGap.value = value;
      }

      if (logoVerticalGapVal) {
        logoVerticalGapVal.textContent = `${value}px`;
      }

      updateLogoAndSave();
    });
  }

  // –ü–æ–≤–æ—Ä–æ—Ç
  if (logoRotationNum) {
    logoRotationNum.addEventListener("input", function () {
      console.log("logoRotationNum changed:", this.value);
      const value = clamp(Math.round(Number(this.value || 0)), -180, 180);
      state.settings.logo.rotation = value;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä
      if (logoRotation) {
        logoRotation.value = value;
      }

      if (logoRotationVal) {
        logoRotationVal.textContent = `${value}¬∞`;
      }

      updateLogoAndSave();
    });
  }

  // –°–º–µ—â–µ–Ω–∏–µ X
  if (logoTileOffsetXNum) {
    logoTileOffsetXNum.addEventListener("input", function () {
      console.log("logoTileOffsetXNum changed:", this.value);
      const value = clamp(Math.round(Number(this.value || 0)), -2000, 2000);
      state.settings.logo.tileOffsetX = value;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä
      if (logoTileOffsetX) {
        logoTileOffsetX.value = value;
      }

      updateLogoAndSave();
    });
  }

  // –°–º–µ—â–µ–Ω–∏–µ Y
  if (logoTileOffsetYNum) {
    logoTileOffsetYNum.addEventListener("input", function () {
      console.log("logoTileOffsetYNum changed:", this.value);
      const value = clamp(Math.round(Number(this.value || 0)), -2000, 2000);
      state.settings.logo.tileOffsetY = value;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä
      if (logoTileOffsetY) {
        logoTileOffsetY.value = value;
      }

      updateLogoAndSave();
    });
  }

  // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
  if (logoOpacityNum) {
    logoOpacityNum.addEventListener("input", function () {
      console.log("logoOpacityNum changed:", this.value);
      const value = clamp(Math.round(Number(this.value || 12)), 0, 100);
      state.settings.logo.opacity = value;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä
      if (logoOpacity) {
        logoOpacity.value = value;
      }

      if (logoOpacityVal) {
        logoOpacityVal.textContent = `${value}%`;
      }

      updateLogoAndSave();
    });
  }

  console.log("Logo number inputs setup complete");
}

function updateValue(value, source) {
  console.log(`updateValue called from ${source}:`, value, 'for', control.param);

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
  let numValue = Number(value);
  if (isNaN(numValue)) {
    console.warn(`Invalid value for ${control.param}:`, value);
    numValue = control.min;
  }

  numValue = clamp(Math.round(numValue), control.min, control.max);
  console.log(`Normalized value for ${control.param}:`, numValue);

  // –û–±–Ω–æ–≤–ª—è–µ–º —á–∏—Å–ª–æ–≤–æ–µ –ø–æ–ª–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ INPUT —ç–ª–µ–º–µ–Ω—Ç)
  if (numInput && numInput.tagName === "INPUT") {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ü–∏–∫–ª–∏—Ç—å—Å—è
    if (Number(numInput.value) !== numValue) {
      numInput.value = numValue;
      console.log(`Updated number input for ${control.param} to:`, numValue);
    }
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)
  if (slider && Number(slider.value) !== numValue) {
    slider.value = numValue;
    console.log(`Updated slider for ${control.param} to:`, numValue);
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞)
  if (valOutput) {
    valOutput.textContent = `${numValue}${control.unit}`;
    console.log(`Updated value display for ${control.param} to:`, numValue + control.unit);
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  if (state.settings.logo[control.param] !== numValue) {
    state.settings.logo[control.param] = numValue;
    console.log(`Updated state for ${control.param} to:`, numValue);

    // –û—á–∏—â–∞–µ–º –∫—ç—à –ø–ª–∏—Ç–æ–∫
    if (window.clearTileBlobCache) {
      console.log('Clearing tile cache');
      window.clearTileBlobCache();
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–æ—Ç–∏–ø
    updateLogoIfNeeded();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    saveState(true);
    console.log(`Saved state for ${control.param}`);
  } else {
    console.log(`Value for ${control.param} unchanged, skipping update.`);
  }
}

// =============–°–ª—É—à–∞—Ç–µ–ª–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ 
// –í —Ñ—É–Ω–∫—Ü–∏–∏ bootstrapCore –∏–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:
tabLogo.addEventListener("click", () => setActiveTab("logo"));
// –í–∞—Ä–∏–∞–Ω—Ç –ª–æ–≥–æ—Ç–∏–ø–∞ (–≤—ã–±–æ—Ä –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞)
if (logoVariant) {
  logoVariant.addEventListener('change', function() {
    const variant = Number(this.value);
    state.settings.logo.variant = variant;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    const logoUploadWrap = $("logoUploadWrap");
    if (logoUploadWrap) {
      logoUploadWrap.style.display = variant === 3 ? 'block' : 'none';
    }
    
    updateLogoAndSave();
  });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–∞ (–≤–∞—Ä–∏–∞–Ω—Ç 3)
if (logoUpload) {
  logoUpload.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      state.settings.logo.uploadedFileData = event.target.result;
      state.settings.logo.variant = 3;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
      if (logoVariant) {
        let hasOption3 = false;
        for (let i = 0; i < logoVariant.options.length; i++) {
          if (logoVariant.options[i].value === '3') {
            hasOption3 = true;
            break;
          }
        }
        
        if (!hasOption3) {
          const option3 = document.createElement('option');
          option3.value = '3';
          option3.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª';
          logoVariant.appendChild(option3);
        }
        
        logoVariant.value = '3';
      }
      
      updateLogoAndSave();
      logoUpload.value = '';
    };
    
    reader.readAsDataURL(file);
  });
}
// –†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ (center, tile, diagonal)
if (logoLayout && !logoLayout.hasLayoutChangeHandler) {
  logoLayout.addEventListener('change', function() {
    state.settings.logo.layout = this.value;
    updateLogoAndSave();
  });
  logoLayout.hasLayoutChangeHandler = true;
}

// –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ª–æ–≥–æ—Ç–∏–ø–∞
if (logoOpacity && !logoOpacity.hasOpacityChangeHandler) {
  logoOpacity.addEventListener('input', function() {
    const value = clamp(Math.round(Number(this.value)), 0, 100);
    state.settings.logo.opacity = value;
    
    if (logoOpacityVal) logoOpacityVal.textContent = `${value}%`;
    if (logoOpacityNum) logoOpacityNum.value = String(value);
    
    updateLogoAndSave();
  });
  logoOpacity.hasOpacityChangeHandler = true;
}

// –†–µ–∂–∏–º –ø–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞–Ω–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞
if (logoRecolor && !logoRecolor.hasRecolorChangeHandler) {
  logoRecolor.addEventListener('change', function() {
    state.settings.logo.recolor = this.checked;
    
    if (logoColorWrap) {
      logoColorWrap.style.display = this.checked ? "block" : "none";
    }
    
    updateLogoAndSave();
  });
  logoRecolor.hasRecolorChangeHandler = true;
}

// –¶–≤–µ—Ç –¥–ª—è –ø–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞–Ω–∏—è
if (logoColor && !logoColor.hasColorChangeHandler) {
  logoColor.addEventListener('change', function() {
    state.settings.logo.color = this.value;
    updateLogoAndSave();
  });
  logoColor.hasColorChangeHandler = true;
}

// –í–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–æ—Ç–∏–ø–∞
if (logoEnabled && !logoEnabled.hasEnabledChangeHandler) {
  logoEnabled.addEventListener('change', function() {
    state.settings.logo.enabled = this.checked;
    updateLogoAndSave();
  });
  logoEnabled.hasEnabledChangeHandler = true;
}

// –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Å–ª–∞–π–¥–µ—Ä–æ–≤ –∏ —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
const controls = [
  { slider: "logoTileSize", num: "logoTileSizeNum", param: "tileSize", min: 0, max: 1000 },
  { slider: "logoHorizontalGap", num: "logoHorizontalGapNum", val: "logoHorizontalGapVal", param: "horizontalGap", min: 0, max: 800 },
  { slider: "logoVerticalGap", num: "logoVerticalGapNum", val: "logoVerticalGapVal", param: "verticalGap", min: 0, max: 800 },
  { slider: "logoRotation", num: "logoRotationNum", val: "logoRotationVal", param: "rotation", min: -180, max: 180 },
  { slider: "logoOpacity", num: "logoOpacityNum", val: "logoOpacityVal", param: "opacity", min: 0, max: 100 },
  { slider: "logoTileOffsetX", num: "logoTileOffsetXNum", param: "tileOffsetX", min: -2000, max: 2000 },
  { slider: "logoTileOffsetY", num: "logoTileOffsetYNum", param: "tileOffsetY", min: -2000, max: 2000 },
];

controls.forEach((control) => {
  const slider = $(control.slider);
  const numInput = $(control.num);
  const valOutput = control.val ? $(control.val) : null;
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞
  if (slider) {
    slider._logoHandler = function() {
      updateValue(this.value, 'slider');
    };
    slider.addEventListener("input", slider._logoHandler);
  }
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–∏—Å–ª–æ–≤–æ–≥–æ –ø–æ–ª—è
  if (numInput && numInput.tagName === "INPUT") {
    numInput._logoHandler = function() {
      updateValue(this.value, 'number-input');
    };
    numInput.addEventListener("input", numInput._logoHandler);
  }
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ª–æ–≥–æ—Ç–∏–ø–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
$("btnSettingsSave").addEventListener("click", saveSettings);

// –í —Ñ—É–Ω–∫—Ü–∏–∏ saveSettings() —Ç–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞:
function saveSettings() {
  // ... –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ...
  
  state.settings.logo.enabled = !!logoEnabled.checked;
  state.settings.logo.opacity = clamp(Math.round(Number(logoOpacity.value ?? 12)), 0, 100);
  state.settings.logo.recolor = !!logoRecolor.checked;
  state.settings.logo.color = String(logoColor.value || "#0ea5e9").trim();
  
  // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–æ—Ç–∏–ø–∞
  if (window.clearTileBlobCache) {
    window.clearTileBlobCache();
  }
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  pushHistory("–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫");
  saveState();
  closeSettings();
  renderAll();
  updateLogoIfNeeded();
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
function renderAll() {
  applyTheme();
  renderFilterBar();
  renderSchedule();
  renderStats();
  markGeometryDirtyIfNeeded();
}

function bootstrapCore() {
  loadState();
  state.version = 13;
  hardenState();

  updateUndoRedoButtons();
  renderDirSwatches();

  if (!$("schedule")) {
    console.error("–≠–ª–µ–º–µ–Ω—Ç #schedule –Ω–µ –Ω–∞–π–¥–µ–Ω!");
    toast("ERR", "–û—à–∏–±–∫–∞", "–ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç —Ç–∞–±–ª–∏—Ü—ã");
    return;
  }

  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –ª–æ–≥–æ—Ç–∏–ø–∞)
  addExportStyles();

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ - –ü–ï–†–ï–î applyTheme()
  ensureLogoLayer();

  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
  applyTheme();

  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π –ª–æ–≥–æ—Ç–∏–ø–∞
  setupLogoNumberInputs();

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–æ–≤
  initLogoSync();

  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  syncInitialValues();

  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ—Ç–∏–ø–∞
  setTimeout(() => {
    applyLogo();
    console.log("–õ–æ–≥–æ—Ç–∏–ø –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
  }, 100);

  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º
  renderAll();

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–∞
  initLogoEventHandlers();

  toast("OK", "–ì–æ—Ç–æ–≤–æ", "–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ.");

  initErrorHandling();
}

function bootstrap() {
  if (isAuthorized()) {
    authorized = true;

    const appRoot = $("appRoot");
    if (appRoot) appRoot.style.display = "";

    const gate = $("authGate");
    if (gate) gate.remove();

    bootstrapCore();
    return;
  }

  const startAfterAuth = () => {
    authorized = true;
    bootstrapCore();
  };

  if (document.readyState === "loading") {
    document.addEventListener(
      "DOMContentLoaded",
      () => renderAuthGate(startAfterAuth),
      { once: true },
    );
  } else {
    renderAuthGate(startAfterAuth);
  }
}

function toast(kind, title, text) {
  const toasts = document.querySelector("#toasts");
  if (!toasts) {
    console.warn("–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–æ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω");
    return;
  }
  
  const el = document.createElement("div");
  el.className = "toast";
  
  const icon = document.createElement("div");
  icon.className = "icon";
  icon.textContent = kind === "OK" ? "‚úì" : kind === "WARN" ? "!" : "√ó";
  icon.style.background = 
    kind === "OK" 
      ? "var(--ok)" 
      : kind === "WARN" 
        ? "var(--warn)" 
        : "var(--danger)";
  
  const content = document.createElement("div");
  content.className = "content";
  const t = document.createElement("div");
  t.className = "title";
  t.textContent = title;
  const d = document.createElement("div");
  d.className = "text";
  d.textContent = text || "";
  content.appendChild(t);
  content.appendChild(d);
  
  const actions = document.createElement("div");
  actions.className = "actions";
  const close = document.createElement("button");
  close.className = "close";
  close.textContent = "√ó";
  close.addEventListener("click", () => el.remove());
  actions.appendChild(close);
  
  el.appendChild(icon);
  el.appendChild(content);
  el.appendChild(actions);
  
  toasts.appendChild(el);
  
  setTimeout(() => {
    if (el.isConnected) el.remove();
  }, 4500);
}

function openSettings() {
  setActiveTab("schedule");
  settingsWarn.style.display = "none";
  settingsWarn.textContent = "";

  const s = state.settings.schedule;
  setStart.value = s.start;
  setEnd.value = s.end;
  setDefaultDur.value = String(s.defaultDuration);

  const d = state.settings.display;
  dispCellView.value = d.cellView;
  dispCardMode.value = d.cardMode;
  dispShowNotes.value = d.showNotes ? "yes" : "no";
  dispShowToday.value = d.showTodayHighlight ? "yes" : "no";
  dispDayWidth.value = String(d.dayWidthPx ?? 0);
  dispCellPad.value = String(d.cellPadPx ?? 6);
  dispShowEmptyHint.value = d.showEmptyHint ? "yes" : "no";

  const f = state.settings.font;

  const presetVal =
    f && typeof f.preset === "string" && f.preset.trim() ? f.preset : "custom";
  const tightnessVal =
    f && typeof f.tightness === "string" && f.tightness.trim()
      ? f.tightness
      : "normal";

  if (fontPreset) fontPreset.value = presetVal;
  if (fontQuickTightness) fontQuickTightness.value = tightnessVal;

  const lg = state.settings.logo;

  if (logoLayout) logoLayout.value = lg.layout || "center";
  if (logoTileSize) logoTileSize.value = String(lg.tileSize ?? 140);

  if (logoHorizontalGap)
    logoHorizontalGap.value = String(lg.horizontalGap ?? 180);
  if (logoVerticalGap) logoVerticalGap.value = String(lg.verticalGap ?? 180);
  if (logoRotation) {
    logoRotation.value = String(lg.rotation ?? 0);
    if (logoRotationVal) {
      logoRotationVal.textContent = `${logoRotation.value}¬∞`;
    }
  }

  if (logoTileOffsetX) logoTileOffsetX.value = String(lg.tileOffsetX ?? 0);
  if (logoTileOffsetY) logoTileOffsetY.value = String(lg.tileOffsetY ?? 0);
  if (logoVariant) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    const currentVariant = String(lg.variant ?? 1);

    // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
    logoVariant.innerHTML = '';

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
    const option1 = document.createElement('option');
    option1.value = '1';
    option1.textContent = '–õ–æ–≥–æ—Ç–∏–ø 1';
    logoVariant.appendChild(option1);

    const option2 = document.createElement('option');
    option2.value = '2';
    option2.textContent = '–õ–æ–≥–æ—Ç–∏–ø 2';
    logoVariant.appendChild(option2);

    // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    if (lg.uploadedFileData) {
      const option3 = document.createElement('option');
      option3.value = '3';
      option3.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª';
      logoVariant.appendChild(option3);
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    logoVariant.value = currentVariant;
  }
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ª–æ–≥–æ—Ç–∏–ø–∞
  if (logoVariant) {
    logoVariant.addEventListener('change', function () {
      const variant = Number(this.value);
      state.settings.logo.variant = variant;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
      const logoUploadWrap = $("logoUploadWrap");
      if (logoUploadWrap) {
        logoUploadWrap.style.display = variant === 3 ? 'block' : 'none';
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–æ—Ç–∏–ø
      updateLogoAndSave();
    });
  }

  const logoUploadWrap = $("logoUploadWrap");
  if (logoUploadWrap && logoVariant) {
    logoUploadWrap.style.display = lg.variant === 3 ? "block" : "none";
  }
  // –í openSettings() –¥–æ–±–∞–≤—å—Ç–µ:
  if (logoHorizontalGapNum) logoHorizontalGapNum.value = String(lg.horizontalGap ?? 180);
  if (logoVerticalGapNum) logoVerticalGapNum.value = String(lg.verticalGap ?? 180);
  if (logoRotationNum) logoRotationNum.value = String(lg.rotation ?? 0);
  if (logoTileOffsetXNum) logoTileOffsetXNum.value = String(lg.tileOffsetX ?? 0);
  if (logoTileOffsetYNum) logoTileOffsetYNum.value = String(lg.tileOffsetY ?? 0);

  logoEnabled.checked = !!lg.enabled;

  logoOpacity.value = String(lg.opacity ?? 12);
  logoOpacityVal.textContent = `${logoOpacity.value}%`;

  logoRecolor.checked = !!lg.recolor;
  logoColor.value = lg.color || "#0ea5e9";
  logoColorWrap.style.display = logoRecolor.checked ? "block" : "none";

  if (logoLayout) logoLayout.value = lg.layout || "center";

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
  if (logoUpload) {
    logoUpload.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞
        state.settings.logo.uploadedFileData = event.target.result;

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç 3
        state.settings.logo.variant = 3;

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç 3
        if (logoVariant) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤–∞—Ä–∏–∞–Ω—Ç 3
          let hasOption3 = false;
          for (let i = 0; i < logoVariant.options.length; i++) {
            if (logoVariant.options[i].value === '3') {
              hasOption3 = true;
              break;
            }
          }

          // –ï—Å–ª–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º
          if (!hasOption3) {
            const option3 = document.createElement('option');
            option3.value = '3';
            option3.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª';
            logoVariant.appendChild(option3);
          }

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ 3
          logoVariant.value = '3';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–æ—Ç–∏–ø
        updateLogoAndSave();

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ input, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª —Å–Ω–æ–≤–∞
        logoUpload.value = '';
      };

      reader.readAsDataURL(file);
    });
  }
  syncLogoPreview();

  if (fontLetterSpacing) fontLetterSpacing.value = String(f.letterSpacing ?? 0);
  if (fontTextTransform) fontTextTransform.value = f.textTransform || "none";
  if (fontTitleClamp) fontTitleClamp.value = String(f.titleClamp ?? 3);
  if (fontCardPaddingY) fontCardPaddingY.value = String(f.cardPadY ?? 7);
  if (fontCardRadius) fontCardRadius.value = String(f.cardRadius ?? 12);

  const mainFam = f.family || "system";
  const titleFam = f.titleFamily || mainFam;
  const metaFam = f.metaFamily || mainFam;

  pickerMain.setSelected(mainFam, true);
  pickerTitle.setSelected(titleFam, true);
  pickerMeta.setSelected(metaFam, true);

  fontFamily.value = mainFam;
  if (typeof fontTitleFamily !== "undefined" && fontTitleFamily)
    fontTitleFamily.value = titleFam;
  if (typeof fontMetaFamily !== "undefined" && fontMetaFamily)
    fontMetaFamily.value = metaFam;

  if (fontLineHeight) fontLineHeight.value = String(f.lineHeight ?? 1.12);
  if (fontTitle1) fontTitle1.value = String(f.titleSize1 ?? 12);
  if (fontTitle2) fontTitle2.value = String(f.titleSize2 ?? 10);
  if (fontMeta1) fontMeta1.value = String(f.metaSize1 ?? 11);
  if (fontMeta2) fontMeta2.value = String(f.metaSize2 ?? 9);
  if (fontWeightTitle) fontWeightTitle.value = String(f.weightTitle ?? 900);
  if (fontWeightMeta) fontWeightMeta.value = String(f.weightMeta ?? 600);

  if (fontSampleText) fontSampleText.value = f.sampleText || "";

  const th = state.settings.theme;
  themeMode.value = th.mode;
  syncLogoLayoutFromState();
  renderThemePresetUI();
  fillThemeInputsFromState();

  settingsBackdrop.classList.add("show");
}








