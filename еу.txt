// ================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
let edgeThreshold = 60; // –£–≤–µ–ª–∏—á–∏–º –ø–æ—Ä–æ–≥ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö

// ================== –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –ø–∞–ª—å—Ü–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
 */
function handleTouchMove(e) {
  if (!touchDragActive || !touchDragElement || !touchDragEventData) {
    if (touchDragTimeout && Date.now() - touchDragStartTime < 1000) {
      clearTimeout(touchDragTimeout);
      touchDragTimeout = null;
      
      if (touchDragFeedback) {
        touchDragFeedback.remove();
        touchDragFeedback = null;
      }
    }
    return;
  }
  
  e.preventDefault();
  
  const currentX = e.touches[0].clientX;
  const currentY = e.touches[0].clientY;
  
  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–ª–æ–Ω–∞ —Å —É—á–µ—Ç–æ–º –≥—Ä–∞–Ω–∏—Ü —ç–∫—Ä–∞–Ω–∞
  if (touchDragElement._clone) {
    const clone = touchDragElement._clone;
    const rect = touchDragElement.getBoundingClientRect();
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —ç–∫—Ä–∞–Ω–∞
    const maxX = window.innerWidth - rect.width / 2;
    const minX = rect.width / 2;
    const maxY = window.innerHeight - rect.height / 2;
    const minY = rect.height / 2;
    
    const clampedX = Math.max(minX, Math.min(currentX, maxX));
    const clampedY = Math.max(minY, Math.min(currentY, maxY));
    
    clone.style.left = `${clampedX - rect.width / 2}px`;
    clone.style.top = `${clampedY - rect.height / 2}px`;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–∫—É—é –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –ª—É—á—à–µ–≥–æ UX
    clone.style.transform = `translate(-50%, -50%) scale(${1.05})`;
    
    // ‚úÖ –í–ê–ñ–ù–û: –ï—Å–ª–∏ –∫—É—Ä—Å–æ—Ä —É –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è, –Ω–µ–º–Ω–æ–≥–æ —Å–º–µ—â–∞–µ–º –∫–ª–æ–Ω –≤–ª–µ–≤–æ
    if (currentX > window.innerWidth - edgeThreshold) {
      clone.style.transform = `translate(-70%, -50%) scale(${1.05})`;
    }
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é
  touchLastX = currentX;
  touchLastY = currentY;
  
  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —è—á–µ–π–∫–∏
  const targetCell = findDropTargetEnhanced(currentX, currentY);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
  if (targetCell && targetCell !== touchDragTargetCell) {
    if (touchDragTargetCell) {
      touchDragTargetCell.classList.remove('drop-target', 'touch-drop-target');
    }
    
    targetCell.classList.add('drop-target', 'touch-drop-target');
    touchDragTargetCell = targetCell;
    
    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏
    highlightRelatedCells(targetCell);
  } else if (!targetCell && touchDragTargetCell) {
    // –ï—Å–ª–∏ —É—à–ª–∏ —Å —è—á–µ–π–∫–∏
    touchDragTargetCell.classList.remove('drop-target', 'touch-drop-target');
    document.querySelectorAll('.cell.droppable.highlight-related').forEach(cell => {
      cell.classList.remove('highlight-related');
    });
    touchDragTargetCell = null;
  }
  
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
  handleAutoScrollEnhanced(currentX, currentY);
}

/**
 * –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —è—á–µ–π–∫–∏ –¥–ª—è –¥—Ä–æ–ø–∞
 */
function findDropTargetEnhanced(x, y) {
  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –∫—Ä–∞–µ–≤ —ç–∫—Ä–∞–Ω–∞
  const adjustedX = Math.max(10, Math.min(x, window.innerWidth - 10));
  const adjustedY = Math.max(10, Math.min(y, window.innerHeight - 10));
  
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ
  const elements = document.elementsFromPoint(adjustedX, adjustedY);
  
  // –ò—â–µ–º droppable —è—á–µ–π–∫—É
  for (const element of elements) {
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    if (element === touchDragElement || 
        element === touchDragElement._clone ||
        element.classList?.contains('auto-scroll-indicator')) {
      continue;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∞–º —ç–ª–µ–º–µ–Ω—Ç
    if (element.classList?.contains('cell') && 
        element.classList?.contains('droppable')) {
      return element;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª–µ–π
    const parentCell = element.closest('.cell.droppable');
    if (parentCell && parentCell !== touchDragElement) {
      return parentCell;
    }
  }
  
  return null;
}

/**
 * –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–∞
 */
function handleAutoScrollEnhanced(x, y) {
  const windowHeight = window.innerHeight;
  const windowWidth = window.innerWidth;
  
  let newVertical = 0;
  let newHorizontal = 0;
  
  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
  const isPortrait = windowHeight > windowWidth;
  const verticalThreshold = isPortrait ? 80 : 60;
  const horizontalThreshold = isPortrait ? 60 : 80;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Ö–Ω–∏–π –∏ –Ω–∏–∂–Ω–∏–π –∫—Ä–∞—è
  if (y < verticalThreshold) {
    newVertical = -1; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö
  } else if (y > windowHeight - verticalThreshold) {
    newVertical = 1; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
  }
  
  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ë–æ–ª–µ–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è
  if (x < horizontalThreshold) {
    newHorizontal = -1; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–ª–µ–≤–æ
  } else if (x > windowWidth - horizontalThreshold) {
    newHorizontal = 1; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–ø—Ä–∞–≤–æ
  }
  
  // –ï—Å–ª–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –æ–±–Ω–æ–≤–ª—è–µ–º
  if (newVertical !== autoScrollVertical || newHorizontal !== autoScrollHorizontal) {
    autoScrollVertical = newVertical;
    autoScrollHorizontal = newHorizontal;
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ—Å–ª–∏ –æ–±–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è 0
    if (autoScrollVertical === 0 && autoScrollHorizontal === 0) {
      stopAutoScroll();
      hideAllScrollIndicators();
    } else {
      // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
      stopAutoScroll();
      startAutoScrollEnhanced();
      updateScrollIndicators();
    }
  }
}

/**
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç —É–ª—É—á—à–µ–Ω–Ω—ã–π –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
 */
function startAutoScrollEnhanced() {
  if (autoScrollInterval) return;
  
  autoScrollInterval = setInterval(() => {
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    const speed = calculateScrollSpeed();
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const view = getCellViewMode();
    
    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
    if (autoScrollVertical !== 0) {
      if (view === "compact") {
        // –í compact —Ä–µ–∂–∏–º–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞
      } else if (verticalScrollContainer && verticalScrollContainer !== window && verticalScrollContainer !== document.body) {
        verticalScrollContainer.scrollTop += autoScrollVertical * speed.vertical;
      } else {
        window.scrollBy(0, autoScrollVertical * speed.vertical);
      }
    }
    
    // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
    if (autoScrollHorizontal !== 0) {
      if (horizontalScrollContainer && horizontalScrollContainer !== window && horizontalScrollContainer !== document.body) {
        horizontalScrollContainer.scrollLeft += autoScrollHorizontal * speed.horizontal;
      } else {
        window.scrollBy(autoScrollHorizontal * speed.horizontal, 0);
      }
    }
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ü–µ–ª–µ–≤–æ–π —è—á–µ–π–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    updateTargetCellAfterScrollEnhanced();
    
  }, 16); // ~60fps
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–ª–µ–≤—É—é —è—á–µ–π–∫—É –ø–æ—Å–ª–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
 */
function updateTargetCellAfterScrollEnhanced() {
  if (!touchLastX || !touchLastY) return;
  
  // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
  const adjustedX = Math.max(10, Math.min(touchLastX, window.innerWidth - 10));
  const adjustedY = Math.max(10, Math.min(touchLastY, window.innerHeight - 10));
  
  // –ò—â–µ–º –Ω–æ–≤—É—é —Ü–µ–ª–µ–≤—É—é —è—á–µ–π–∫—É
  const newTargetCell = findDropTargetEnhanced(adjustedX, adjustedY);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–ª–µ–≤—É—é —è—á–µ–π–∫—É
  if (newTargetCell && newTargetCell !== touchDragTargetCell) {
    if (touchDragTargetCell) {
      touchDragTargetCell.classList.remove('drop-target', 'touch-drop-target');
    }
    
    newTargetCell.classList.add('drop-target', 'touch-drop-target');
    touchDragTargetCell = newTargetCell;
    
    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏
    highlightRelatedCells(newTargetCell);
  }
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Ä–µ–∂–∏–º–∞
 */
function calculateScrollSpeed() {
  const view = getCellViewMode();
  const isMobile = isMobileDevice();
  
  if (view === "compact") {
    // –í compact —Ä–µ–∂–∏–º–µ —Ç–æ–ª—å–∫–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
    return { vertical: 0, horizontal: isMobile ? 30 : 20 };
  } else if (view === "timeline") {
    // –í timeline –æ–±–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    return { vertical: isMobile ? 25 : 15, horizontal: isMobile ? 35 : 25 };
  } else if (view === "list") {
    // –í list –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è
    return { vertical: isMobile ? 30 : 20, horizontal: isMobile ? 20 : 15 };
  }
  
  return { vertical: 20, horizontal: 20 };
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –∫–ª–æ–Ω –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
 */
function createDragClone(element, startX, startY) {
  const clone = element.cloneNode(true);
  const rect = element.getBoundingClientRect();
  
  // –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
  clone.replaceWith(clone.cloneNode(true));
  
  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∫–ª–æ–Ω –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞
  clone.style.cssText = `
    position: fixed;
    left: ${startX}px;
    top: ${startY}px;
    width: ${rect.width}px;
    height: ${rect.height}px;
    z-index: 9999;
    opacity: 0.95;
    box-shadow: 
      0 10px 40px rgba(0, 0, 0, 0.3),
      0 0 0 2px rgba(14, 165, 233, 0.5);
    pointer-events: none;
    transform: translate(-50%, -50%) scale(1.05);
    transition: transform 0.2s, opacity 0.2s;
    border-radius: 6px;
    overflow: hidden;
    will-change: transform;
  `;
  
  // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
  if (isMobileDevice()) {
    const dragIndicator = document.createElement('div');
    dragIndicator.style.cssText = `
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(14, 165, 233, 0.9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    `;
    dragIndicator.textContent = '‚Üï‚Üî';
    clone.appendChild(dragIndicator);
  }
  
  document.body.appendChild(clone);
  return clone;
}

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
 */
function startTouchDrag(e) {
  if (!touchDragElement || !touchDragEventData) return;
  
  touchDragActive = true;
  
  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
  verticalScrollContainer = findScrollableContainer('vertical');
  horizontalScrollContainer = findScrollableContainer('horizontal');
  
  // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º window
  if (!verticalScrollContainer || verticalScrollContainer === document.body) {
    verticalScrollContainer = window;
  }
  if (!horizontalScrollContainer || horizontalScrollContainer === document.body) {
    horizontalScrollContainer = window;
  }
  
  // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
  createScrollIndicator();
  
  // –£–¥–∞–ª—è–µ–º —Ñ–∏–¥–±–µ–∫
  if (touchDragFeedback) {
    touchDragFeedback.style.opacity = '0';
    setTimeout(() => {
      if (touchDragFeedback && touchDragFeedback.parentNode) {
        touchDragFeedback.remove();
      }
    }, 200);
  }
  
  // –°–æ–∑–¥–∞–µ–º –∫–ª–æ–Ω –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
  const clone = createDragClone(touchDragElement, touchDragStartX, touchDragStartY);
  touchDragElement.dataset.clone = 'true';
  touchDragElement._clone = clone;
  
  // –í–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
  touchDragElement.classList.add('dragging', 'touch-dragging');
  document.body.classList.add('touch-dragging-active');
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
  toast('INFO', 'üì± –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ', '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –∑–∞–Ω—è—Ç–∏–µ. –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —É –∫—Ä–∞–µ–≤ —ç–∫—Ä–∞–Ω–∞');
}

/**
 * –ù–∞—Ö–æ–¥–∏—Ç scrollable –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
 */
function findScrollableContainer(direction = 'vertical') {
  // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π
  const selectors = direction === 'vertical' 
    ? ['.schedule', '.table-wrapper', '.scroll-container', 'main', 'article']
    : ['.schedule-wrap', '.table-wrapper', '.horizontal-scroll', 'main', 'article'];
  
  for (const selector of selectors) {
    const element = document.querySelector(selector);
    if (element) {
      const style = window.getComputedStyle(element);
      if (direction === 'vertical') {
        if (element.scrollHeight > element.clientHeight && 
            (style.overflowY === 'auto' || style.overflowY === 'scroll')) {
          return element;
        }
      } else {
        if (element.scrollWidth > element.clientWidth && 
            (style.overflowX === 'auto' || style.overflowX === 'scroll')) {
          return element;
        }
      }
    }
  }
  
  return null;
}

/**
 * –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∏ —Å–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
 */
function stopAutoScroll() {
  if (autoScrollInterval) {
    clearInterval(autoScrollInterval);
    autoScrollInterval = null;
  }
  hideAllScrollIndicators();
}

/**
 * –°–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
 */
function hideAllScrollIndicators() {
  document.querySelectorAll('.auto-scroll-indicator').forEach(indicator => {
    indicator.style.opacity = '0';
  });
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
 */
function updateScrollIndicators() {
  // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ
  hideAllScrollIndicators();
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ
  if (autoScrollVertical === -1) {
    const topIndicator = document.querySelector('.auto-scroll-indicator.top');
    if (topIndicator) topIndicator.style.opacity = '1';
  }
  if (autoScrollVertical === 1) {
    const bottomIndicator = document.querySelector('.auto-scroll-indicator.bottom');
    if (bottomIndicator) bottomIndicator.style.opacity = '1';
  }
  if (autoScrollHorizontal === -1) {
    const leftIndicator = document.querySelector('.auto-scroll-indicator.left');
    if (leftIndicator) leftIndicator.style.opacity = '1';
  }
  if (autoScrollHorizontal === 1) {
    const rightIndicator = document.querySelector('.auto-scroll-indicator.right');
    if (rightIndicator) {
      rightIndicator.style.opacity = '1';
      // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
      rightIndicator.style.animation = 'pulse 1s infinite';
    }
  }
}

// ================== –î–û–ë–ê–í–õ–Ø–ï–ú –°–¢–ò–õ–ò ====================
function addMobileDragStyles() {
  const styleId = 'mobile-drag-styles';
  if (document.getElementById(styleId)) return;
  
  const style = document.createElement('style');
  style.id = styleId;
  style.textContent = `
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ */
    @keyframes pulse {
      0% { transform: translateY(-50%) scale(1); }
      50% { transform: translateY(-50%) scale(1.1); }
      100% { transform: translateY(-50%) scale(1); }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–∞–≤–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ */
    .auto-scroll-indicator.right {
      animation: pulse 1s infinite;
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
    .touch-dragging-active {
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    
    .event.dragging.touch-dragging {
      opacity: 0.4 !important;
      transform: scale(0.95);
      transition: opacity 0.3s, transform 0.3s;
    }
    
    .cell.droppable.drop-target.touch-drop-target {
      background-color: rgba(14, 165, 233, 0.2) !important;
      box-shadow: inset 0 0 0 3px rgba(14, 165, 233, 0.8);
      transition: all 0.2s ease;
    }
    
    .cell.droppable.highlight-related {
      background-color: rgba(14, 165, 233, 0.1) !important;
    }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
    .auto-scroll-indicator {
      position: fixed;
      z-index: 9998;
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.95), rgba(59, 130, 246, 0.95));
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: bold;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    
    .auto-scroll-indicator.top {
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .auto-scroll-indicator.bottom {
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .auto-scroll-indicator.left {
      top: 50%;
      left: 20px;
      transform: translateY(-50%);
      writing-mode: vertical-rl;
      text-orientation: mixed;
      padding: 16px 12px;
    }
    
    .auto-scroll-indicator.right {
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      writing-mode: vertical-rl;
      text-orientation: mixed;
      padding: 16px 12px;
    }
  `;
  
  document.head.appendChild(style);
}

// ================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
function initMobileDragAndDrop() {
  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
  addMobileDragStyles();
  
  // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
  document.addEventListener('touchmove', (e) => {
    if (touchDragActive) {
      e.preventDefault();
    }
  }, { passive: false });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  document.addEventListener('touchstart', handleTouchStart, { passive: false });
  document.addEventListener('touchmove', handleTouchMove, { passive: false });
  document.addEventListener('touchend', handleTouchEnd, { passive: true });
  document.addEventListener('touchcancel', handleTouchEnd, { passive: true });
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
  showMobileDragHint();
}

// –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ —É–ª—É—á—à–µ–Ω–Ω—ã–µ
const originalHandleTouchMove = handleTouchMove;
handleTouchMove = function(e) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–ª–∏ —Å—Ç–∞—Ä—É—é, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫–∞—è –µ—Å—Ç—å
  if (typeof handleTouchMoveEnhanced !== 'undefined') {
    return handleTouchMoveEnhanced(e);
  }
  return originalHandleTouchMove(e);
};